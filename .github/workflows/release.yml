name: Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type (based on conventional commits)'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Bump version and create tag
        id: tag
        uses: anothrNick/github-tag-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BUMP: ${{ github.event.inputs.bump_type }}
          WITH_V: false
          RELEASE_BRANCHES: main,master
          VERBOSE: true
          GIT_API_TAGGING: false

      - name: Update manifest.json version
        run: |
          # Get version from tag (no v prefix with WITH_V: false)
          NEW_VERSION="${{ steps.tag.outputs.new_tag }}"

          echo "Updating manifest.json to version $NEW_VERSION"

          # Update manifest.json with the new version using node
          node -e "
            const fs = require('fs');
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            manifest.version = '$NEW_VERSION';
            fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, '\\t'));
          "

          # Update versions.json (set npm_package_version for the script)
          export npm_package_version="$NEW_VERSION"
          node version-bump.mjs

          # Add changes (even if no changes, we'll handle it)
          git add manifest.json versions.json

          # Always create a commit (allow empty if manifest already at correct version)
          # This ensures the tag points to a release-specific commit
          git commit --allow-empty -m "chore: release $NEW_VERSION"

      - name: Move tag to release commit
        run: |
          TAG="${{ steps.tag.outputs.new_tag }}"
          echo "Moving tag $TAG to the release commit"
          git tag -f $TAG
          git push origin $TAG --force

      - name: Push changes
        run: |
          git push origin HEAD

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          fromTag: ${{ steps.tag.outputs.previous_tag }}
          toTag: ${{ steps.tag.outputs.new_tag }}
          failOnError: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build release artifacts
        run: npm run build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.new_tag }}
          name: ${{ steps.tag.outputs.new_tag }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            main.js
            manifest.json
            styles.css
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Obsidian community (manual step)
        run: |
          echo "=========================================="
          echo "Release created successfully!"
          echo "=========================================="
          echo ""
          echo "Next steps (manual):"
          echo "1. Submit plugin to Obsidian community:"
          echo "   https://github.com/obsidianmd/obsidian-releases"
          echo ""
          echo "2. Create a PR to add/update your plugin in:"
          echo "   - community-plugins.json"
          echo ""
          echo "3. Follow the format in existing entries"
          echo "=========================================="
